@using EntityLayer.Concrete
@model List<Transaction>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/UserLayout.cshtml";
}

<div class="content-wrapper">
    <section class="content">
        <div class="container-fluid">

            @* Admin ve Accountant için kartlar ve grafik *@
            @if (User.IsInRole("Admin") || User.IsInRole("Accountant"))
            {
                <div class="row">
                    <div class="col-lg-4 col-6">
                        <div class="small-box bg-success">
                            <div class="inner">
                                <p>Toplam Gelir</p>
                                <h3>@ViewBag.TotalIncome.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</h3>
                            </div>
                            <div class="icon"><i class="fas fa-arrow-up"></i></div>
                            <a href="/Income" class="small-box-footer">Detaylı Gör <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>

                    <div class="col-lg-4 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <p>Toplam Gider</p>
                                <h3>@ViewBag.TotalExpense.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</h3>
                            </div>
                            <div class="icon"><i class="fas fa-arrow-down"></i></div>
                            <a href="/Expense" class="small-box-footer">Detaylı Gör <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>

                    <div class="col-lg-4 col-6">
                        <div class="small-box bg-gradient-yellow">
                            <div class="inner">
                                <p>Net Bakiye</p>
                                <h3>@ViewBag.NetBalance.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</h3>
                            </div>
                            <div class="icon"><i class="fas fa-balance-scale"></i></div>
                            <a href="/Reports" class="small-box-footer">Detaylı Gör <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <section class="col-lg-8 connectedSortable">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-line mr-1"></i> Aylık Gelir / Gider</h3>
                                <h4 class="text-right">@DateTime.Now.Year</h4>
                            </div>
                            <div class="card-body">
                                <canvas id="incomeExpenseChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </section>

                    <section class="col-lg-4 connectedSortable">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-receipt mr-1"></i> Son İşlemler</h3>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Tarih</th>
                                            <th>Category</th>
                                            <th>Tutar</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in ViewBag.LastTransactions)
                                        {
                                            <tr>
                                                <td>@item.CreatedAt</td>
                                                <td>@item.Category</td>
                                                <td>@item.Amount.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>
            }

            @* Member için defter bazlı kartlar, grafik ve son işlemler *@
            @if (User.IsInRole("Member"))
            {
                <div class="row">
                    @foreach (var ledger in ViewBag.MemberLedgerData)
                    {
                        <div class="col-lg-4 col-6">
                            <div class="small-box bg-success">
                                <div class="inner">
                                    <p>Toplam Gelir - @ledger.ledgerName</p>
                                    <h3>@ledger.totalIncome.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</h3>
                                </div>
                                <div class="icon"><i class="fas fa-arrow-up"></i></div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-6">
                            <div class="small-box bg-danger">
                                <div class="inner">
                                    <p>Toplam Gider - @ledger.ledgerName</p>
                                    <h3>@ledger.totalExpense.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</h3>
                                </div>
                                <div class="icon"><i class="fas fa-arrow-down"></i></div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-6">
                            <div class="small-box bg-gradient-yellow">
                                <div class="inner">
                                    <p>Net Bakiye - @ledger.ledgerName</p>
                                    <h3>@ledger.netBalance.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</h3>
                                </div>
                                <div class="icon"><i class="fas fa-balance-scale"></i></div>
                            </div>
                        </div>
                    }
                </div>

                <div class="row">
                    @for (int i = 0; i < ViewBag.MemberLedgerData.Count; i++)
                    {
                        var ledger = ViewBag.MemberLedgerData[i];
                        <section class="col-lg-8 connectedSortable">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-chart-line mr-1"></i> Aylık Gelir / Gider - @ledger.ledgerName</h3>
                                </div>
                                <div class="card-body">
                                    <canvas id="chart_@i" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        </section>
                    }
                </div>

                <div class="row">
                    @foreach (var ledger in ViewBag.MemberLedgerData)
                    {
                        <section class="col-lg-6 connectedSortable">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-receipt mr-1"></i> Son İşlemler - @ledger.ledgerName</h3>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Tarih</th>
                                                <th>Category</th>
                                                <th>Tutar</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in ledger.lastTransactions)
                                            {
                                                <tr>
                                                    <td>@item.CreatedAt</td>
                                                    <td>@item.Category</td>
                                                    <td>@item.Amount.ToString("N2", new System.Globalization.CultureInfo("tr-TR")) ₺</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    }
                </div>
            }

        </div>
    </section>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    @* Admin/Accountant chart *@
    @if (User.IsInRole("Admin") || User.IsInRole("Accountant"))
    {
        <script>
            var ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Months)),
                    datasets: [
                        {
                            label: 'Gelir',
                            backgroundColor: 'rgba(40,167,69,0.2)',
                            borderColor: 'rgba(40,167,69,1)',
                            data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.MonthlyIncome))
                                    },
                        {
                            label: 'Gider',
                            backgroundColor: 'rgba(220,53,69,0.2)',
                            borderColor: 'rgba(220,53,69,1)',
                            data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.MonthlyExpense))
                                    }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        </script>
    }

    @* Member chart *@
    @if (User.IsInRole("Member"))
    {
        <script>
            @for (int i = 0; i < ViewBag.MemberLedgerData.Count; i++)
            {
                var ledger = ViewBag.MemberLedgerData[i];
                <text>
                                var ctx = document.getElementById("chart_@i").getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ledger.months)),
                        datasets: [
                            {
                                label: 'Gelir',
                                backgroundColor: 'rgba(40,167,69,0.2)',
                                borderColor: 'rgba(40,167,69,1)',
                                data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ledger.monthlyIncome))
                                            },
                            {
                                label: 'Gider',
                                backgroundColor: 'rgba(220,53,69,0.2)',
                                borderColor: 'rgba(220,53,69,1)',
                                data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ledger.monthlyExpense))
                                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + context.raw.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' ₺';
                                    }
                                }
                            }
                        }
                    }
                });
                </text>
            }
        </script>
    }
}
