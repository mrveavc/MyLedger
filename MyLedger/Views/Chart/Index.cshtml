@model EntityLayer.Concrete.Transaction

@{
	ViewData["Title"] = "Bar Chart";
	Layout = "~/Views/Shared/UserLayout.cshtml";
}

<div class="content-wrapper">
	<section class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">

					<div class="form-group">
						<label for="Year">Yıl Seç</label>
						<select id="Year" name="Year" class="form-control" asp-items="ViewBag.yearValues">
							<option value="">Seçiniz...</option>
						</select>
					</div>

					<div class="card card-success">
						<div class="card-header">
							<h3 class="card-title">Yıllık Kar/Zarar Grafiği</h3>
						</div>
						<div class="card-body">
							<canvas id="barChart" style="min-height:250px; height:250px; max-height:400px; max-width:100%;"></canvas>
						</div>
					</div>

				</div>
			</div>
		</div>
	</section>
</div>

<script src="~/adminlte/plugins/jquery/jquery.min.js"></script>
<script src="~/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="~/adminlte/plugins/chart.js/Chart.min.js"></script>

    @if (User.IsInRole("Admin") || User.IsInRole("Accountant"))
    {
            <script>
            $(function () {
                var ctx = $('#barChart').get(0).getContext('2d');
                var barChart;
                var labels = [
                    'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                    'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
                ];

                function loadChart(year) {
                    $.getJSON('/Chart/GetTransactionsByYear', { year: year }, function (res) {
                        var data = {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Gelir',
                                    backgroundColor: 'rgba(60,141,188,0.9)',
                                    borderColor: 'rgba(60,141,188,0.8)',
                                    data: res.gelir
                                },
                                {
                                    label: 'Gider',
                                    backgroundColor: 'rgba(210, 214, 222, 1)',
                                    borderColor: 'rgba(210, 214, 222, 1)',
                                    data: res.gider
                                }
                            ]
                        };

                        var options = {
                            responsive: true,
                            maintainAspectRatio: false,
                            datasetFill: false
                        };

                        if (barChart) barChart.destroy();

                        barChart = new Chart(ctx, {
                            type: 'bar',
                            data: data,
                            options: options
                        });
                    });
                }

                var defaultYear = '@ViewBag.defaultYear';
                $('#Year').val(defaultYear);
                loadChart(defaultYear);

                $('#Year').change(function () {
                    var selectedYear = $(this).val();
                    if (selectedYear) loadChart(selectedYear);
                });
            });
    </script>
    }
    @if (User.IsInRole("Member") )
    {
       <script>
        $(function () {
            var ctx = $('#barChart').get(0).getContext('2d');
            var barChart;
            var labels = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];

            function loadChart(year) {
                $.getJSON('/Chart/GetTransactionsByYearAndLedger', { year: year }, function (res) {
                    var datasets = [];

                    res.forEach(function (ledger) {
                        // Gelir dataset
                        datasets.push({
                            label: ledger.ledgerName + ' Gelir',
                            backgroundColor: 'rgba(60,141,188,0.7)',
                            borderColor: 'rgba(60,141,188,1)',
                            data: ledger.gelir
                        });
                        // Gider dataset
                        datasets.push({
                            label: ledger.ledgerName + ' Gider',
                            backgroundColor: 'rgba(210,214,222,0.7)',
                            borderColor: 'rgba(210,214,222,1)',
                            data: ledger.gider
                        });
                    });

                    var data = {
                        labels: labels,
                        datasets: datasets
                    };

                    var options = {
                        responsive: true,
                        maintainAspectRatio: false,
                        datasetFill: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + context.formattedValue;
                                    }
                                }
                            }
                        }
                    };

                    if (barChart) barChart.destroy();
                    barChart = new Chart(ctx, {
                        type: 'bar',
                        data: data,
                        options: options
                    });
                });
            }

            var defaultYear = '@ViewBag.defaultYear';
            $('#Year').val(defaultYear);
            loadChart(defaultYear);

            $('#Year').change(function () {
                var selectedYear = $(this).val();
                if (selectedYear) loadChart(selectedYear);
            });
        });
       </script>
    }